{% extends "templates/web.html" %}

{% block style %}
<link rel="stylesheet" href="/assets/imogi_pos/css/base.css">
<link rel="stylesheet" href="/assets/imogi_pos/css/components.css">
<link rel="stylesheet" href="/assets/imogi_pos/css/cashier_console.css">

<style>
  :root {
    --primary-color: {{ branding.primary_color }};
    --accent-color: {{ branding.accent_color }};
    --header-bg: {{ branding.header_bg }};
  }
  
  .cashier-console {
    display: grid;
    grid-template-columns: 1fr 350px;
    gap: 20px;
    height: calc(100vh - 60px);
    padding: 1rem;
    background-color: #f5f7fa;
  }
  
  .order-list-container {
    overflow-y: auto;
    background-color: white;
    border-radius: 8px;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    padding: 1rem;
  }
  
  .checkout-panel {
    background-color: white;
    border-radius: 8px;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    padding: 1rem;
    display: flex;
    flex-direction: column;
  }
  
  .order-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
    padding-bottom: 0.5rem;
    border-bottom: 1px solid #eee;
  }
  
  .order-tabs {
    display: flex;
    gap: 1rem;
    margin-bottom: 1rem;
  }
  
  .order-tab {
    padding: 0.5rem 1rem;
    border-radius: 4px;
    cursor: pointer;
    font-weight: 500;
  }
  
  .order-tab.active {
    background-color: var(--primary-color);
    color: white;
  }
  
  .order-card {
    padding: 1rem;
    border: 1px solid #eee;
    border-radius: 4px;
    margin-bottom: 1rem;
    cursor: pointer;
    transition: all 0.2s;
  }
  
  .order-card:hover {
    border-color: var(--accent-color);
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
  }
  
  .order-card.selected {
    border-color: var(--accent-color);
    background-color: rgba(36, 144, 239, 0.05);
  }
  
  .order-meta {
    display: flex;
    justify-content: space-between;
    margin-bottom: 0.5rem;
    font-size: 0.9rem;
    color: #666;
  }
  
  .order-items {
    margin-top: 0.5rem;
    font-size: 0.9rem;
  }
  
  .checkout-panel-header {
    font-weight: 600;
    margin-bottom: 1rem;
    padding-bottom: 0.5rem;
    border-bottom: 1px solid #eee;
  }
  
  .checkout-items {
    flex: 1;
    overflow-y: auto;
    margin-bottom: 1rem;
  }
  
  .checkout-item {
    display: flex;
    justify-content: space-between;
    padding: 0.5rem 0;
    border-bottom: 1px solid #f5f5f5;
  }
  
  .checkout-totals {
    margin-top: auto;
    border-top: 1px solid #eee;
    padding-top: 1rem;
  }
  
  .total-row {
    display: flex;
    justify-content: space-between;
    margin-bottom: 0.5rem;
  }
  
  .grand-total {
    font-weight: 600;
    font-size: 1.1rem;
    margin-top: 0.5rem;
    padding-top: 0.5rem;
    border-top: 1px solid #eee;
  }
  
  .checkout-actions {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
    margin-top: 1rem;
  }
  
  .btn-checkout {
    background-color: var(--primary-color);
    color: white;
    border: none;
    padding: 0.75rem;
    border-radius: 4px;
    font-weight: 500;
    cursor: pointer;
  }
  
  .btn-checkout:hover {
    background-color: #3a4651;
  }
  
  .btn-payment {
    background-color: var(--accent-color);
    color: white;
    border: none;
    padding: 0.75rem;
    border-radius: 4px;
    font-weight: 500;
    cursor: pointer;
  }
  
  .btn-payment:hover {
    background-color: #1a7fd1;
  }
  
  .btn-print {
    background-color: #f5f5f5;
    color: #333;
    border: 1px solid #ddd;
    padding: 0.75rem;
    border-radius: 4px;
    font-weight: 500;
    cursor: pointer;
  }
  
  .btn-print:hover {
    background-color: #e9e9e9;
  }
  
  .search-container {
    margin-bottom: 1rem;
  }
  
  .search-input {
    width: 100%;
    padding: 0.75rem;
    border: 1px solid #ddd;
    border-radius: 4px;
  }
  
  .customer-info {
    margin-bottom: 1rem;
    padding: 0.75rem;
    background-color: #f9f9f9;
    border-radius: 4px;
    font-size: 0.9rem;
  }
  
  .customer-info-header {
    display: flex;
    justify-content: space-between;
    margin-bottom: 0.5rem;
  }
  
  .customer-search-btn {
    color: var(--accent-color);
    cursor: pointer;
    font-size: 0.9rem;
  }
  
  .session-warning {
    background-color: #fff3cd;
    color: #856404;
    padding: 0.75rem;
    border-radius: 4px;
    margin-bottom: 1rem;
    text-align: center;
  }
  
  .disabled {
    opacity: 0.6;
    pointer-events: none;
  }
  
  @media (max-width: 768px) {
    .cashier-console {
      grid-template-columns: 1fr;
    }
  }
</style>
{% endblock %}

{% block page_content %}
{% if show_header %}
<header class="app-header">
  <div class="header-left">
    <a href="/" class="home-link">
      <i class="fa fa-home"></i>
    </a>
    <h1 class="page-title">{{ _("Cashier Console") }}</h1>
  </div>
  <div class="header-center">
    {% if branding.logo %}
    <img src="{{ branding.logo }}" alt="{{ branding.name }}" class="brand-logo">
    {% else %}
    <span class="brand-name">{{ branding.name }}</span>
    {% endif %}
  </div>
  <div class="header-right">
    {% if branch %}
    <div class="branch-selector">
      <span class="branch-label">{{ _("Branch") }}:</span>
      <span class="branch-value">{{ branch }}</span>
    </div>
    {% endif %}
    <div class="user-menu">
      <span class="user-name">{{ frappe.session.user }}</span>
    </div>
  </div>
</header>
{% endif %}

{% if require_pos_session and enforce_session_on_cashier and not has_active_session %}
<div class="session-warning">
  {{ _("No active POS Session. Please open a session to continue.") }}
  <a href="/desk#pos-session/new-pos-session-1" class="btn btn-sm btn-primary ml-2">{{ _("Open Session") }}</a>
</div>
{% endif %}

<div class="cashier-console {% if require_pos_session and enforce_session_on_cashier and not has_active_session %}disabled{% endif %}">
  <div class="order-list-container">
    <div class="order-header">
      <h2>{{ _("Orders") }}</h2>
      <div class="header-actions">
        <button id="refresh-orders" class="btn btn-sm btn-default">
          <i class="fa fa-refresh"></i> {{ _("Refresh") }}
        </button>
      </div>
    </div>
    
    <div class="order-tabs">
      <div class="order-tab active" data-status="Ready">{{ _("Ready") }}</div>
      <div class="order-tab" data-status="Served">{{ _("Served") }}</div>
      <div class="order-tab" data-status="All">{{ _("All") }}</div>
    </div>
    
    <div class="search-container">
      <input type="text" class="search-input" placeholder="{{ _('Search by order number, table, or customer...') }}">
    </div>
    
    <div id="order-list" class="order-list">
      <!-- Orders will be populated here -->
      <div class="empty-state">
        <p>{{ _("Loading orders...") }}</p>
      </div>
    </div>
  </div>
  
  <div class="checkout-panel">
    <div class="checkout-panel-header">{{ _("Checkout") }}</div>
    
    <div class="customer-info">
      <div class="customer-info-header">
        <span>{{ _("Customer") }}: <span id="customer-name">{{ _("Walk-in Customer") }}</span></span>
        <span class="customer-search-btn" id="find-customer">{{ _("Find / Create") }}</span>
      </div>
      <div id="customer-details" class="customer-details"></div>
    </div>
    
    <div id="checkout-items" class="checkout-items">
      <!-- Checkout items will be populated here -->
      <div class="empty-state">
        <p>{{ _("Select an order to checkout") }}</p>
      </div>
    </div>
    
    <div class="checkout-totals">
      <div class="total-row">
        <span>{{ _("Subtotal") }}</span>
        <span id="subtotal">0.00</span>
      </div>
      <div class="total-row">
        <span>{{ _("Tax") }}</span>
        <span id="tax-amount">0.00</span>
      </div>
      <div class="total-row">
        <span>{{ _("Discount") }}</span>
        <span id="discount-amount">0.00</span>
      </div>
      <div class="grand-total total-row">
        <span>{{ _("Total") }}</span>
        <span id="grand-total">0.00</span>
      </div>
    </div>
    
    <div class="checkout-actions">
      <button id="btn-generate-invoice" class="btn-checkout" disabled>
        {{ _("Generate Invoice") }}
      </button>
      <button id="btn-request-payment" class="btn-payment" disabled>
        {{ _("Request Payment") }}
      </button>
      <button id="btn-print-bill" class="btn-print" disabled>
        {{ _("Print Bill") }}
      </button>
    </div>
  </div>
</div>

{% endblock %}

{% block script %}
<script>
  // Pass important context variables to the frontend
  const FRAPPE_CSRF_TOKEN = '{{ frappe.session.csrf_token }}';
  const POS_PROFILE = {{ pos_profile.name | tojson if pos_profile else 'null' }};
  const ACTIVE_POS_SESSION = {{ active_pos_session.name | tojson if active_pos_session else 'null' }};
  const CURRENT_BRANCH = {{ branch | tojson if branch else 'null' }};
  const CURRENCY_SYMBOL = '{{ frappe.get_doc("Currency", frappe.defaults.get_global_default("currency")).symbol }}';
  const DOMAIN = '{{ domain }}';
</script>

<script src="/assets/imogi_pos/js/nav.js"></script>
<script src="/assets/imogi_pos/js/auth.js"></script>
<script src="/assets/imogi_pos/js/branch.js"></script>
<script src="/assets/imogi_pos/js/print/service.js"></script>
<script src="/assets/imogi_pos/www/cashier-console/index.js"></script>
{% endblock %}