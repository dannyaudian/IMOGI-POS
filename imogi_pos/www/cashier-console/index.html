{% extends "templates/web.html" %}

{% block style %}
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;500;700&family=Poppins:wght@400;500;700&display=swap" rel="stylesheet">

<link rel="stylesheet" href="/assets/imogi_pos/css/base.css">
<link rel="stylesheet" href="/assets/imogi_pos/css/components.css">
<link rel="stylesheet" href="/assets/imogi_pos/css/cashier_console.css">

<style>
  :root{
    --primary: #000;     /* hitam */
    --accent:  #333;     /* abu gelap */
    --surface: #fff;     /* putih */
    --surface-2: #f7f7f7;
    --border:  #ddd;
    --text:    #111;
    --muted:   #666;

    --radius: 12px;
    --shadow-sm: 0 1px 2px rgba(0,0,0,.06);
    --shadow-md: 0 4px 12px rgba(0,0,0,.08);
  }

  body{
    font-family: "Ubuntu", "Poppins", sans-serif;
    background: var(--surface-2);
    color: var(--text);
  }

  /* Header */
  .app-header{
    background: var(--surface);
    border-bottom: 1px solid var(--border);
    padding: 14px 20px;
    display:grid;
    grid-template-columns: 1fr auto 1fr;
    align-items:center;
    box-shadow: var(--shadow-sm);
  }
  .page-title{font-weight:700;font-size:18px;margin:0;}

  /* Card */
  .card{
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    box-shadow: var(--shadow-md);
  }
  .card-body{padding:16px;}

  /* Input */
  input, .search-input{
    width:100%;
    padding:10px 12px;
    border:1px solid var(--border);
    border-radius:10px;
    background: var(--surface);
    color: var(--text);         /* isi teks hitam */
  }
  input::placeholder{color: var(--muted);} /* placeholder abu */

  /* Button */
  .btn{
    border:1px solid var(--border);
    border-radius:10px;
    padding:10px 14px;
    cursor:pointer;
    background: var(--surface-2);
    color: var(--text);
    font-weight:600;
    transition:.2s;
  }
  .btn:hover{background:#eaeaea;}
  .btn-primary{background:var(--text);color:#fff;}
  .btn-primary:hover{background:#000;}

  /* Tab */
  .order-tab{
    border:1px solid var(--border);
    border-radius:999px;
    padding:6px 12px;
    font-size:13px;
    color: var(--muted);
    background: var(--surface);
    cursor:pointer;
  }
  .order-tab.active{background:#000;color:#fff;border-color:#000;}

  /* Total section */
  .grand-total{font-size:18px;font-weight:700;}

  /* Empty state */
  .empty-state{
    text-align:center;
    color:var(--muted);
    border:1px dashed var(--border);
    border-radius:12px;
    padding:20px;
    background: var(--surface);
  }
</style>
{% endblock %}

{% block page_content %}

{% if show_header %}
<header class="app-header">
  <div class="header-left">
    <a href="/" class="home-link" aria-label="Home">
      <i class="fa fa-home" aria-hidden="true"></i>
    </a>
    <h1 class="page-title">{{ _("Cashier Console") }}</h1>
  </div>

  <div class="header-center" aria-label="Brand">
    {% if branding.logo %}
      {% if branding.logo_dark %}
      <picture>
        <source srcset="{{ branding.logo_dark }}" media="(prefers-color-scheme: dark)">
        <img src="{{ branding.logo }}" alt="{{ branding.name|default('IMOGI POS') }}" class="brand-logo">
      </picture>
      {% else %}
      <img src="{{ branding.logo }}" alt="{{ branding.name|default('IMOGI POS') }}" class="brand-logo">
      {% endif %}
    {% else %}
      <span class="brand-name">{{ branding.name|default("IMOGI POS") }}</span>
    {% endif %}
  </div>

  <div class="header-right">
    {% if branch %}
    <div class="branch-selector" role="status" aria-live="polite">
      <span class="branch-label">{{ _("Branch") }}:</span>
      <span class="branch-value badge">{{ branch }}</span>
    </div>
    {% endif %}
    <div class="user-menu">
      <span class="user-name badge"><i class="fa fa-user" aria-hidden="true"></i>&nbsp;{{ frappe.session.user }}</span>
    </div>
  </div>
</header>
{% endif %}

{% if error_message %}
  <div class="error-message card"><div class="card-body">
    {{ error_message }}
  </div></div>
{% elif require_pos_session and enforce_session_on_cashier and not has_active_session %}
  <div class="session-warning card">
    <div class="card-body" style="display:flex;justify-content:space-between;align-items:center;gap:12px;">
      <span>{{ _("No active POS Session. Please open a session to continue.") }}</span>
      <a href="/desk#pos-session/new-pos-session-1" class="btn btn-primary">{{ _("Open Session") }}</a>
    </div>
  </div>
{% endif %}

{% if not error_message %}
<div class="cashier-console {% if require_pos_session and enforce_session_on_cashier and not has_active_session %}disabled{% endif %}">
  <!-- Order list -->
  <section class="order-list-container card" aria-labelledby="orders-heading">
    <div class="order-header">
      <h2 id="orders-heading" class="section-title" style="border:none; padding:0; margin:0">{{ _("Orders") }}</h2>
      <button id="refresh-orders" class="btn btn-default" type="button">
        <i class="fa fa-rotate" aria-hidden="true"></i>&nbsp;{{ _("Refresh") }}
      </button>
    </div>

    <div class="order-tabs" role="tablist" aria-label="{{ _('Order filters') }}">
      <div class="order-tab active" role="tab" aria-selected="true" tabindex="0" data-status="Ready">{{ _("Ready") }}</div>
      <div class="order-tab" role="tab" aria-selected="false" tabindex="0" data-status="Served">{{ _("Served") }}</div>
      <div class="order-tab" role="tab" aria-selected="false" tabindex="0" data-status="All">{{ _("All") }}</div>
    </div>

    <div class="search-container">
      <label class="sr-only" for="order-search">{{ _('Search Orders') }}</label>
      <input id="order-search" type="text" class="search-input" placeholder="{{ _('Search by order number, table, or customer...') }}" aria-label="{{ _('Search Orders') }}">
    </div>

    <div id="order-list" class="order-list">
      <div class="empty-state" aria-live="polite">
        <div>
          <strong>{{ _("Loading ordersâ€¦") }}</strong>
          <div style="font-size:12px;margin-top:4px">{{ _("Please wait while we fetch recent orders.") }}</div>
        </div>
      </div>
    </div>
  </section>

  <!-- Checkout -->
  <aside class="checkout-panel card" aria-labelledby="checkout-heading">
    <div class="checkout-panel-header" id="checkout-heading">{{ _("Checkout") }}</div>

    <div class="customer-info" aria-labelledby="customer-heading">
      <div class="customer-info-header">
        <span id="customer-heading">{{ _("Customer") }}:
          <span id="customer-name" class="badge">{{ _("Walk-in Customer") }}</span>
        </span>
        <button class="customer-search-btn" id="find-customer" type="button" aria-describedby="customer-heading">{{ _("Find / Create") }}</button>
      </div>
      <div id="customer-details" class="customer-details" style="font-size:13px; color:var(--muted)"></div>
    </div>

    <div id="checkout-items" class="checkout-items">
      <div class="empty-state">
        <div>
          <strong>{{ _("Select an order to checkout") }}</strong>
          <div style="font-size:12px;margin-top:4px">{{ _("Choose an item on the left to see details here.") }}</div>
        </div>
      </div>
    </div>

    <div class="checkout-totals">
      <div class="total-row"><span>{{ _("Subtotal") }}</span><span id="subtotal">0.00</span></div>
      <div class="total-row"><span>{{ _("Tax") }}</span><span id="tax-amount">0.00</span></div>
      <div class="total-row"><span>{{ _("Discount") }}</span><span id="discount-amount">0.00</span></div>
      <div class="grand-total total-row"><span>{{ _("Total") }}</span><span id="grand-total">0.00</span></div>
    </div>

    <div class="checkout-actions">
      <button id="btn-generate-invoice" class="btn btn-primary" type="button" disabled>{{ _("Generate Invoice") }}</button>
      <button id="btn-request-payment" class="btn btn-accent" type="button" disabled>{{ _("Request Payment") }}</button>
      <button id="btn-print-bill" class="btn btn-ghost" type="button" disabled>{{ _("Print Bill") }}</button>
    </div>
  </aside>
</div>
{% endif %}
{% endblock %}

{% block script %}
<script>
  // Pass context to JS
  const FRAPPE_CSRF_TOKEN = '{{ frappe.session.csrf_token }}';
  const POS_PROFILE        = {{ (pos_profile.name if pos_profile else none) | tojson }};
  const ACTIVE_POS_SESSION = {{ (active_pos_session.name if active_pos_session else none) | tojson }};
  const CURRENT_BRANCH     = {{ (branch if branch else none) | tojson }};
  const CURRENCY_SYMBOL    = '{{ currency_symbol }}';
  const DOMAIN             = '{{ domain|default("Restaurant") }}';
  const HAS_ERROR          = {{ (error_message if error_message else false) | tojson }};

  // Minor UX: toggle active class on tabs with keyboard support
  document.addEventListener('DOMContentLoaded', () => {
    const tabs = Array.from(document.querySelectorAll('.order-tab'));
    tabs.forEach(tab => {
      tab.addEventListener('click', () => setActive(tab));
      tab.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); setActive(tab); }
      });
    });
    function setActive(el){
      tabs.forEach(t => t.classList.remove('active'));
      el.classList.add('active');
      el.setAttribute('aria-selected', 'true');
      tabs.filter(t=>t!==el).forEach(t=>t.setAttribute('aria-selected','false'));
      // TODO: hook filter logic by data-status here if needed
    }

    // Header shadow on scroll
    const header = document.querySelector('.app-header');
    if (header) {
      const onScroll = () => header.style.boxShadow = window.scrollY > 6 ? 'var(--shadow-md)' : 'var(--shadow-sm)';
      document.addEventListener('scroll', onScroll, { passive: true });
      onScroll();
    }
  });
</script>

{# IMPORTANT: include_script meng-output <script> tag, jadi JANGAN dibungkus <script src="..."> #}
{{ include_script('imogi_pos/js/nav.js') }}
{{ include_script('imogi_pos/js/auth.js') }}
{{ include_script('imogi_pos/js/branch.js') }}
{{ include_script('imogi_pos/js/print/adapter_bluetooth.js') }}
{{ include_script('imogi_pos/js/print/adapter_bridge.js') }}
{{ include_script('imogi_pos/js/print/adapter_spool.js') }}

<script src="../cashier-console/index.js"></script>
{% endblock %}
