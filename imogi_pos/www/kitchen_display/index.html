{% extends "templates/web.html" %}

{% block style %}
<!-- Font Awesome untuk ikon -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
<link rel="stylesheet" href="/assets/imogi_pos/css/base.css">
<link rel="stylesheet" href="/assets/imogi_pos/css/components.css">
<link rel="stylesheet" href="/assets/imogi_pos/css/kitchen_display.css">

<style>
  /* ===== OVERRIDE VARIABLES ===== */
  :root {
    --brand-primary: {{ branding.primary_color }};
    --brand-accent: {{ branding.accent_color }};
    --brand-header-bg: {{ branding.header_bg }};
    {% if branding.text_color %}
    --brand-text: {{ branding.text_color }};
    {% endif %}
    
    --orange: #FF9800;
    --blue: #2196F3;
    --green: #4CAF50;
    --red: #F44336;
    --grey-50: #FAFAFA;
    --grey-100: #F5F5F5;
    --grey-200: #EEEEEE;
    --grey-700: #616161;
    --grey-900: #212121;
  }
  
  * {
    box-sizing: border-box;
  }
  
  .hidden { 
    display: none !important; 
  }
  
  /* ===== MAIN CONTAINER ===== */
  #kitchen-display {
    height: 100vh;
    display: flex;
    flex-direction: column;
    background: var(--grey-100);
    overflow: hidden;
  }

  /* ===== HEADER OVERRIDE ===== */
  #kitchen-display .kitchen-header {
    background: white !important;
    padding: 20px 24px !important;
    border-bottom: 2px solid var(--grey-200) !important;
    box-shadow: 0 2px 12px rgba(0,0,0,0.06) !important;
  }

  /* ===== COLUMNS CONTAINER ===== */
  #kitchen-display .kitchen-columns {
    display: grid !important;
    grid-template-columns: repeat(3, 1fr) !important;
    gap: 20px !important;
    padding: 20px !important;
    height: calc(100vh - 140px) !important;
    overflow: hidden !important;
    background: var(--grey-100) !important;
  }

  /* ===== EACH COLUMN ===== */
  #kitchen-display .kitchen-column {
    display: flex !important;
    flex-direction: column !important;
    background: white !important;
    border-radius: 16px !important;
    overflow: hidden !important;
    box-shadow: 0 4px 20px rgba(0,0,0,0.08) !important;
  }

  /* ===== COLUMN HEADERS ===== */
  #kitchen-display .kitchen-column > h4 {
    margin: 0 !important;
    padding: 20px 24px !important;
    font-size: 15px !important;
    font-weight: 700 !important;
    text-transform: uppercase !important;
    letter-spacing: 1px !important;
    display: flex !important;
    justify-content: space-between !important;
    align-items: center !important;
    border-bottom: 3px solid !important;
  }

  /* Queued Column Header */
  #kitchen-display .kitchen-column:nth-child(1) > h4 {
    background: linear-gradient(135deg, #FFE0B2 0%, #FFECB3 100%) !important;
    color: #E65100 !important;
    border-bottom-color: var(--orange) !important;
  }

  /* In Progress Column Header */
  #kitchen-display .kitchen-column:nth-child(2) > h4 {
    background: linear-gradient(135deg, #BBDEFB 0%, #90CAF9 100%) !important;
    color: #0D47A1 !important;
    border-bottom-color: var(--blue) !important;
  }

  /* Ready Column Header */
  #kitchen-display .kitchen-column:nth-child(3) > h4 {
    background: linear-gradient(135deg, #C8E6C9 0%, #A5D6A7 100%) !important;
    color: #1B5E20 !important;
    border-bottom-color: var(--green) !important;
  }

  /* Count Badge in Header */
  #kitchen-display .kitchen-column > h4 span {
    display: inline-flex !important;
    align-items: center !important;
    justify-content: center !important;
    min-width: 36px !important;
    height: 36px !important;
    padding: 0 12px !important;
    background: white !important;
    border-radius: 18px !important;
    font-size: 15px !important;
    font-weight: 800 !important;
    box-shadow: 0 2px 8px rgba(0,0,0,0.15) !important;
  }

  /* ===== COLUMN BODY (Scrollable Area) ===== */
  #kitchen-display .kitchen-column > div:not(h4) {
    flex: 1 !important;
    overflow-y: auto !important;
    padding: 16px !important;
    background: var(--grey-50) !important;
  }

  /* Custom Scrollbar */
  #kitchen-display .kitchen-column > div::-webkit-scrollbar {
    width: 10px;
  }

  #kitchen-display .kitchen-column > div::-webkit-scrollbar-track {
    background: transparent;
  }

  #kitchen-display .kitchen-column > div::-webkit-scrollbar-thumb {
    background: #E0E0E0;
    border-radius: 5px;
  }

  #kitchen-display .kitchen-column > div::-webkit-scrollbar-thumb:hover {
    background: #BDBDBD;
  }

  /* ===== KOT CARDS ===== */
  #kitchen-display .kot-card {
    background: white !important;
    border-radius: 12px !important;
    margin-bottom: 16px !important;
    box-shadow: 0 3px 10px rgba(0,0,0,0.1) !important;
    overflow: hidden !important;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1) !important;
    border-left: 6px solid #ddd !important;
  }

  #kitchen-display .kot-card:hover {
    box-shadow: 0 8px 24px rgba(0,0,0,0.15) !important;
    transform: translateY(-4px) !important;
  }

  /* Card Border Colors by Column */
  #kitchen-display .kitchen-column:nth-child(1) .kot-card {
    border-left-color: var(--orange) !important;
  }

  #kitchen-display .kitchen-column:nth-child(2) .kot-card {
    border-left-color: var(--blue) !important;
  }

  #kitchen-display .kitchen-column:nth-child(3) .kot-card {
    border-left-color: var(--green) !important;
  }

  /* ===== CARD STRUCTURE ===== */
  /* Card Header */
  #kitchen-display .kot-card > div:first-child,
  #kitchen-display .kot-card-header {
    padding: 18px 20px !important;
    background: linear-gradient(to bottom, white, var(--grey-50)) !important;
    border-bottom: 2px solid var(--grey-100) !important;
  }

  /* KOT Number/Title */
  #kitchen-display .kot-card h5,
  #kitchen-display .kot-card > div:first-child > strong:first-child {
    font-size: 24px !important;
    font-weight: 800 !important;
    color: var(--grey-900) !important;
    margin: 0 0 12px 0 !important;
    display: block !important;
    letter-spacing: -0.5px !important;
  }

  /* Time Badge */
  #kitchen-display .kot-card .time-badge,
  #kitchen-display .kot-card [class*="badge"],
  #kitchen-display .kot-card > div:first-child > span {
    display: inline-flex !important;
    align-items: center !important;
    gap: 6px !important;
    padding: 6px 14px !important;
    background: linear-gradient(135deg, #FFF3E0 0%, #FFE0B2 100%) !important;
    color: #E65100 !important;
    border-radius: 20px !important;
    font-size: 13px !important;
    font-weight: 700 !important;
    border: 2px solid #FFE0B2 !important;
    margin-bottom: 8px !important;
  }

  /* Meta Info */
  #kitchen-display .kot-card > div:first-child > div,
  #kitchen-display .kot-card > div:first-child > small,
  #kitchen-display .kot-card > div:first-child > p {
    font-size: 13px !important;
    line-height: 1.8 !important;
    color: var(--grey-700) !important;
    margin: 2px 0 !important;
  }

  /* ===== CARD BODY (Items) ===== */
  #kitchen-display .kot-card > div:nth-child(2),
  #kitchen-display .kot-card-body {
    padding: 16px 20px !important;
    background: white !important;
  }

  /* Each Item Row */
  #kitchen-display .kot-card > div:nth-child(2) > div,
  #kitchen-display .kot-item {
    display: flex !important;
    align-items: flex-start !important;
    gap: 14px !important;
    padding: 14px 0 !important;
    border-bottom: 2px dashed var(--grey-200) !important;
  }

  #kitchen-display .kot-card > div:nth-child(2) > div:first-child {
    padding-top: 0 !important;
  }

  #kitchen-display .kot-card > div:nth-child(2) > div:last-child {
    border-bottom: none !important;
    padding-bottom: 0 !important;
  }

  /* Quantity Badge */
  #kitchen-display .kot-card > div:nth-child(2) > div > span:first-child,
  #kitchen-display .kot-card > div:nth-child(2) > div > strong:first-child,
  #kitchen-display .kot-item-qty {
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
    min-width: 44px !important;
    height: 44px !important;
    background: linear-gradient(135deg, #212121 0%, #616161 100%) !important;
    color: white !important;
    border-radius: 12px !important;
    font-size: 18px !important;
    font-weight: 800 !important;
    flex-shrink: 0 !important;
    box-shadow: 0 4px 12px rgba(0,0,0,0.25) !important;
  }

  /* Item Name */
  #kitchen-display .kot-card > div:nth-child(2) > div > span:last-child,
  #kitchen-display .kot-card > div:nth-child(2) > div > div,
  #kitchen-display .kot-item-name {
    flex: 1 !important;
    font-size: 16px !important;
    font-weight: 600 !important;
    color: var(--grey-900) !important;
    line-height: 1.4 !important;
  }

  /* Item Notes */
  #kitchen-display .kot-card > div:nth-child(2) > div > div > small,
  #kitchen-display .kot-card > div:nth-child(2) > div > div > div,
  #kitchen-display .kot-item-notes {
    font-size: 13px !important;
    color: #757575 !important;
    margin-top: 4px !important;
  }

  /* ===== CARD FOOTER (Actions) ===== */
  #kitchen-display .kot-card > div:last-child,
  #kitchen-display .kot-card-footer {
    padding: 16px 20px !important;
    background: var(--grey-50) !important;
    border-top: 2px solid var(--grey-100) !important;
    display: flex !important;
    gap: 10px !important;
  }

  /* Buttons */
  #kitchen-display .kot-card button {
    flex: 1 !important;
    display: inline-flex !important;
    align-items: center !important;
    justify-content: center !important;
    gap: 8px !important;
    padding: 13px 20px !important;
    border: none !important;
    border-radius: 10px !important;
    font-size: 14px !important;
    font-weight: 700 !important;
    text-transform: uppercase !important;
    letter-spacing: 0.5px !important;
    cursor: pointer !important;
    transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1) !important;
    box-shadow: 0 3px 8px rgba(0,0,0,0.12) !important;
  }

  #kitchen-display .kot-card button:hover {
    transform: translateY(-3px) !important;
    box-shadow: 0 6px 20px rgba(0,0,0,0.2) !important;
  }

  /* Primary Button (First button in card) */
  #kitchen-display .kot-card button:first-child,
  #kitchen-display .kot-card .btn-start,
  #kitchen-display .kot-card .btn-complete {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
    color: white !important;
  }

  /* Green button for Ready column */
  #kitchen-display .kitchen-column:nth-child(3) .kot-card button:first-child,
  #kitchen-display .kitchen-column:nth-child(3) .kot-card .btn-serve {
    background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%) !important;
  }

  /* Icon Buttons */
  #kitchen-display .kot-card button:not(:first-child) {
    flex: 0 0 auto !important;
    min-width: 48px !important;
    padding: 13px !important;
    background: white !important;
    color: var(--grey-700) !important;
    border: 2px solid #E0E0E0 !important;
  }

  /* ===== EMPTY STATE ===== */
  #kitchen-display .empty-state,
  #kitchen-display .no-orders {
    display: flex !important;
    flex-direction: column !important;
    align-items: center !important;
    justify-content: center !important;
    padding: 80px 20px !important;
    text-align: center !important;
    color: #BDBDBD !important;
  }

  #kitchen-display .empty-state::before,
  #kitchen-display .no-orders::before {
    content: "üìã" !important;
    font-size: 64px !important;
    margin-bottom: 16px !important;
    opacity: 0.5 !important;
  }

  /* ===== LOADING ===== */
  #kitchen-display .loading-indicator {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 100%;
    padding: 60px;
    background: white;
  }

  #kitchen-display .spinner {
    width: 64px;
    height: 64px;
    border: 6px solid #EEEEEE;
    border-top: 6px solid var(--blue);
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin-bottom: 24px;
  }

  @keyframes spin {
    to { transform: rotate(360deg); }
  }

  /* ===== RESPONSIVE ===== */
  @media (max-width: 1200px) {
    #kitchen-display .kitchen-columns {
      grid-template-columns: repeat(2, 1fr) !important;
    }
    
    #kitchen-display .kitchen-column:nth-child(3) {
      grid-column: 1 / -1 !important;
    }
  }

  @media (max-width: 768px) {
    #kitchen-display .kitchen-columns {
      grid-template-columns: 1fr !important;
    }
    
    #kitchen-display .kitchen-column:nth-child(3) {
      grid-column: auto !important;
    }
  }
</style>
{% endblock %}

{% block content %}
<div id="kitchen-display">
  <div class="loading-indicator">
    <div class="spinner"></div>
    <p>Memuat Kitchen Display...</p>
  </div>
</div>
{% endblock %}

{% block script %}
<script>
  const POS_PROFILE = {{ pos_profile.name | tojson if pos_profile else 'null' }};
  const CURRENT_BRANCH = {{ branch | tojson if branch else 'null' }};
  const DOMAIN = '{{ domain }}';
  const BRANDING = {{ branding | tojson }};
</script>

<script src="/assets/imogi_pos/js/nav.js"></script>
<script src="/assets/imogi_pos/js/branch.js"></script>
<script src="/assets/imogi_pos/js/kitchen_display.js"></script>
<script src="/assets/imogi_pos/js/fix_kitchen_display.js"></script>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    console.log('üöÄ Kitchen Display: Initializing...');
    
    setTimeout(function() {
      if (typeof imogi_pos === 'undefined') {
        console.error('‚ùå imogi_pos not found');
        return;
      }
      
      if (typeof imogi_pos.kitchen_display === 'undefined') {
        console.error('‚ùå kitchen_display not found');
        return;
      }
      
      try {
        console.log('‚úÖ Starting initialization...');
        
        imogi_pos.kitchen_display.init({
          container: '#kitchen-display',
          kitchenSelector: '#kitchen-selector',
          stationSelector: '#station-selector',
          refreshInterval: 30000
        });
        
        console.log('‚úÖ Kitchen Display initialized successfully!');
        
      } catch (err) {
        console.error('‚ùå Initialization error:', err);
      }
    }, 300);
  });
</script>
{% endblock %}
