{% extends "templates/web.html" %}

{% block style %}
<!-- Load Font Awesome untuk ikon -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
<!-- Load CSS dasar -->
<link rel="stylesheet" href="/assets/imogi_pos/css/base.css">
<link rel="stylesheet" href="/assets/imogi_pos/css/components.css">
<!-- Load Kitchen Display CSS -->
<link rel="stylesheet" href="/assets/imogi_pos/css/kitchen_display.css">
<style>
  /* CSS kritis yang dibutuhkan */
  :root {
    --brand-primary: {{ branding.primary_color }};
    --brand-accent: {{ branding.accent_color }};
    --brand-header-bg: {{ branding.header_bg }};
    {% if branding.text_color %}
    --brand-text: {{ branding.text_color }};
    {% endif %}
  }
  
  /* Utility classes */
  .hidden {
    display: none !important;
  }
  
  /* Style dasar untuk container utama */
  #kitchen-display {
    font-family: 'Roboto', 'Open Sans', sans-serif;
    height: 100vh;
    display: flex;
    flex-direction: column;
    background-color: #f5f5f5;
    color: #333;
    position: relative;
  }
  
  /* Loading indicator */
  .loading-indicator {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 100%;
    padding: 40px;
    text-align: center;
  }
  
  .spinner {
    width: 50px;
    height: 50px;
    border: 5px solid #f3f3f3;
    border-top: 5px solid #3498db;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin-bottom: 20px;
  }
  
  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }
</style>
{% endblock %}

{% block content %}
<div id="kitchen-display">
  <!-- Loading indicator -->
  <div class="loading-indicator">
    <div class="spinner"></div>
    <p>Memuat Kitchen Display System...</p>
  </div>
</div>
{% endblock %}

{% block script %}
<script>
  // Konstanta global yang dibutuhkan
  const POS_PROFILE = {{ pos_profile.name | tojson if pos_profile else 'null' }};
  const CURRENT_BRANCH = {{ branch | tojson if branch else 'null' }};
  const DOMAIN = '{{ domain }}';
  const BRANDING = {{ branding | tojson }};
</script>

<!-- Load script dalam urutan yang benar -->
<script src="/assets/imogi_pos/js/nav.js"></script>
<script src="/assets/imogi_pos/js/branch.js"></script>
<script src="/assets/imogi_pos/js/kitchen_display.js"></script>

<!-- Script inisialisasi KDS -->
<script>
  /**
   * Tampilkan pesan error jika terjadi masalah
   */
  function showError(message, details) {
    const container = document.getElementById('kitchen-display');
    if (!container) return;
    
    container.innerHTML = `
      <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 40px; text-align: center; height: 100%;">
        <div style="color: #f44336; font-size: 64px; margin-bottom: 20px;">
          <i class="fas fa-exclamation-triangle"></i>
        </div>
        <h2 style="font-size: 24px; margin-bottom: 16px;">Error Kitchen Display</h2>
        <p style="font-size: 16px; margin-bottom: 20px;">${message || 'Modul Kitchen Display tidak dapat dimuat'}</p>
        ${details ? `<div style="background-color: #f9f9f9; padding: 12px; border-radius: 4px; margin-bottom: 20px; max-width: 600px; text-align: left;"><pre style="margin: 0; white-space: pre-wrap;">${details}</pre></div>` : ''}
        <button onclick="location.reload()" style="background-color: #2196F3; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; font-size: 16px; display: flex; align-items: center; gap: 8px;">
          <i class="fas fa-sync"></i> Muat Ulang Halaman
        </button>
      </div>
    `;
  }

  // Inisialisasi Kitchen Display System ketika DOM siap
  document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM Loaded, inisialisasi Kitchen Display System...');
    
    // Periksa ketersediaan objek yang dibutuhkan
    if (typeof frappe === 'undefined') {
      return showError('Frappe tidak tersedia', 'Framework Frappe belum dimuat dengan benar.');
    }
    
    if (typeof imogi_pos === 'undefined') {
      return showError('Modul imogi_pos tidak tersedia', 'Pastikan library imogi_pos dimuat dengan benar.');
    }
    
    if (typeof imogi_pos.kitchen_display === 'undefined') {
      return showError('Modul Kitchen Display tidak tersedia', 'File kitchen_display.js mungkin tidak dimuat dengan benar.');
    }
    
    if (typeof imogi_pos.kitchen_display.lifecycle === 'undefined' || 
        typeof imogi_pos.kitchen_display.lifecycle.init !== 'function') {
      return showError('Fungsi inisialisasi Kitchen Display tidak tersedia', 
                      'Objek lifecycle.init tidak ditemukan dalam kitchen_display.js.');
    }
    
    // Pastikan Font Awesome dimuat
    if (!document.querySelector('link[href*="font-awesome"]')) {
      const faLink = document.createElement('link');
      faLink.rel = 'stylesheet';
      faLink.href = 'https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css';
      document.head.appendChild(faLink);
    }

    // Jeda kecil untuk memastikan semua script dimuat
    setTimeout(function() {
      try {
        // Inisialisasi Kitchen Display
        console.log('Menginisialisasi Kitchen Display...');
        imogi_pos.kitchen_display.lifecycle.init({
          container: '#kitchen-display',
          kitchenSelector: '#kitchen-selector',
          stationSelector: '#station-selector',
          refreshInterval: 30000
        }).catch(err => {
          console.error('Error saat inisialisasi Kitchen Display:', err);
          showError('Error saat inisialisasi Kitchen Display', err.message || err);
        });
      } catch (err) {
        console.error('Gagal menginisialisasi Kitchen Display:', err);
        showError('Gagal menginisialisasi Kitchen Display', err.message || err);
      }
    }, 300); // Tunggu 300ms untuk memastikan semua library dimuat
  });
</script>
{% endblock %}
